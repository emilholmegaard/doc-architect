name: Nightly Build

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

env:
  DOCKER_IMAGE: ghcr.io/${{ github.repository_owner }}/doc-architect

jobs:
  build:
    name: Build & Test
    uses: ./.github/workflows/build.yml
    with:
      run-tests: true
  
  integration-tests:
    name: Integration Tests
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'
      
      - name: Run integration tests
        run: ./mvnw verify -DskipUnitTests
        continue-on-error: true
      
      - name: Upload integration test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: '**/target/failsafe-reports/'
          retention-days: 30
  
  code-quality:
    name: Code Quality Analysis
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'
      
      - name: Code coverage report
        run: ./mvnw jacoco:report
        continue-on-error: true
      
      - name: Static analysis
        run: |
          if grep -q spotbugs pom.xml 2>/dev/null; then
            ./mvnw spotbugs:check
          fi
        continue-on-error: true
      
      - name: Checkstyle
        run: |
          if grep -q checkstyle pom.xml 2>/dev/null; then
            ./mvnw checkstyle:check
          fi
        continue-on-error: true
  
  dependency-check:
    name: Dependency Security Check
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'
      
      - name: OWASP Dependency Check
        run: |
          ./mvnw org.owasp:dependency-check-maven:check \
            -DfailBuildOnCVSS=7 \
            -DsuppressionFile=.github/dependency-check-suppressions.xml
        continue-on-error: true
      
      - name: Upload dependency report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report
          path: target/dependency-check-report.html
          retention-days: 30
  
  docker:
    name: Docker Build & Push
    needs: build
    uses: ./.github/workflows/docker-build.yml
    with:
      push-image: true
      image-tag: nightly
    secrets: inherit
  
  docker-scan:
    name: Comprehensive Security Scan
    needs: docker
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run Trivy scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.DOCKER_IMAGE }}:nightly
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'
          scanners: 'vuln,secret,config'
      
      - name: Upload Trivy results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'
      
      - name: Run Grype scanner
        uses: anchore/scan-action@v7
        id: grype
        with:
          image: ${{ env.DOCKER_IMAGE }}:nightly
          fail-build: false
          severity-cutoff: high
      
      - name: Upload Grype results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: ${{ steps.grype.outputs.sarif }}
      
      - name: Generate SBOM
        run: |
          docker run --rm \
            -v /var/run/docker.sock:/var/run/docker.sock \
            anchore/syft:latest \
            ${{ env.DOCKER_IMAGE }}:nightly \
            -o json > sbom.json
      
      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom-nightly
          path: sbom.json
          retention-days: 90
      
      - name: Check for critical vulnerabilities
        id: vuln-check
        run: |
          docker run --rm \
            -v /var/run/docker.sock:/var/run/docker.sock \
            aquasec/trivy image \
            --format json \
            --severity CRITICAL,HIGH \
            ${{ env.DOCKER_IMAGE }}:nightly > scan-results.json
          
          CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' scan-results.json)
          HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' scan-results.json)
          
          echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high=$HIGH" >> $GITHUB_OUTPUT
      
      - name: Create issue if vulnerabilities found
        if: steps.vuln-check.outputs.critical != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const critical = '${{ steps.vuln-check.outputs.critical }}';
            const high = '${{ steps.vuln-check.outputs.high }}';
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Security Alert: ${critical} Critical Vulnerabilities (Nightly)`,
              body: `## Nightly Security Scan Results
              
              - **Critical**: ${critical}
              - **High**: ${high}
              
              [View Details](https://github.com/${context.repo.owner}/${context.repo.repo}/security/code-scanning)
              
              *Nightly scan on ${new Date().toISOString()}*`,
              labels: ['security', 'critical', 'nightly']
            });
  
  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: java
          queries: security-extended,security-and-quality
      
      - name: Set up JDK 17
        uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'
      
      - name: Build
        run: ./mvnw clean package -DskipTests
      
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
